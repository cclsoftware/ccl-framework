"use strict";(()=>{var m=class s{scripts=[];addScript=t=>{if(t.source==null||t.source.url==null)return null;let e=this.findScriptIndex(t.source.url);return e>-1?(this.clearBreakpointsForScript(this.scripts[e].script),this.scripts[e]={script:t}):this.scripts.push({script:t}),this.getFileName(t.source.url)};getFileName=t=>{let e="/";return t.indexOf("#")>-1&&(e="#"),t.substring(t.lastIndexOf(e)+1)};findScriptIndex=t=>this.scripts.findIndex(e=>e.script.url!=null&&t!=null&&this.getFileName(e.script.url)==this.getFileName(t));getScriptAt=t=>this.scripts[t]==null?null:this.scripts[t].script;findScript=t=>{let e=this.findScriptIndex(t),r=null;if(e>-1&&(r=this.scripts[e]),r==null||r.script.source==null){println('"'+t+'" is not loaded yet.'),println("Loaded scripts:");for(let i of this.scripts)i.script.url!=null&&println(i.script.url);return null}return r};clearAllBreakpoints=()=>{for(let t of this.scripts)this.clearBreakpointsForScript(t.script)};clearBreakpointsForScript=t=>{t.clearAllBreakpoints();let e=t.getChildScripts();for(let r of e)this.clearBreakpointsForScript(r)};getFrameMetadata=t=>{if(t.script==null||t.script.url==null)return null;let e=t.script.url,r=this.findScript(e);r!=null&&r.path!=null&&(e=r.path);let i=t.script.getOffsetMetadata(t.offset);return{name:this.getFileName(e)+":"+(i.lineNumber+1),source:{name:this.getFileName(e),path:e},line:i.lineNumber,col:i.columnNumber}};collectDebugPointsForScript=(t,e)=>{let r=e.getPossibleBreakpoints();for(let i of r){let l=t.find(n=>n.lineNumber===i.lineNumber);l==null&&(l={lineNumber:i.lineNumber,script:e,debugPoints:[]},t.push(l)),l.debugPoints.push({offset:i.offset,columnNumber:i.columnNumber})}for(let i of t)i.debugPoints.sort((l,n)=>l.columnNumber-n.columnNumber)};collectDebugLines=(t,e)=>{this.collectDebugPointsForScript(t,e);let r=e.getChildScripts();for(let i of r)this.collectDebugLines(t,i);t.sort((i,l)=>i.lineNumber-l.lineNumber)};static isPrimitive=t=>typeof t=="number"||typeof t=="string"||typeof t=="boolean"||typeof t>"u"||typeof t=="bigint";static isExcludedTopLevelSymbol=t=>{let e=["globalThis","JSON","Math","WebAssembly","NaN","Infinity","Intl","Reflect","NativeUserDataClass","exports"];return t.startsWith("Native_0x")||e.indexOf(t)>-1};getObjectEnvironmentValues=(t,e,r,i,l=[],n=0)=>{if(e==null){t[r]=e;return}if(e.callable||n>20||n==0&&s.isExcludedTopLevelSymbol(r))return;let c=l.find(f=>f.obj===e);if(c!=null){t[r]=c.value;return}if(e.getOwnPropertyNames!=null){let f=e.getOwnPropertyNames();if(f.length==0&&e.isProxy)t[r]={};else{t[r]={};for(let b of f){let k=e.getProperty(b);k&&"return"in k&&this.getObjectEnvironmentValues(t[r],k.return,b,i,l,n++)}}}else if(Array.isArray(e)){t[r]=[];for(let f of e){let b={value:void 0};this.getObjectEnvironmentValues(b,f,"value",i,l,n++),t[r].push(b)}}else s.isPrimitive(e)?t[r]=e:t[r]={};l.push({obj:e,value:t[r]})};getDebuggerFrameValues=t=>{let e={},r=t.environment;for(;r!=null;){if(r.inspectable){let i=r.names();for(let l of i){if(l.startsWith("__"))continue;let n=r.getVariable(l);n&&typeof n=="object"&&"class"in n?this.getObjectEnvironmentValues(e,n,l,r):e[l]=n}}r=r.parent}return e}};var u;(a=>(a.kEvent="event",a.kRequest="request",a.kResponse="response",a.kStopped="stopped",a.kSetBreakpoints="setBreakpoints",a.kStackTrace="stackTrace",a.kSource="source",a.kScopes="scopes",a.kVariables="variables",a.kContinue="continue",a.kNext="next",a.kDisconnect="disconnect",a.kFailed="failed",a.kBreakpoint="breakpoint",a.kStep="step"))(u||={});var P=!1,v={},B=-1,o=null,x=-1,N={},h=1,L=1,y=4294967295,d=!1,p=new m,S=class{constructor(t){this.breakReason=t}hit(t){o=t,h=1,N={};let e=p.getFrameMetadata(t);x=e?e.line:-1,V({type:u.kEvent,event:u.kStopped,body:{reason:this.breakReason,threadId:B},seq:-1}),d=!0,pause(!0)}},R=(s,t)=>{v[p.getFileName(s)]={lineNumbers:t,path:s};let e={},r=p.findScript(s);if(r==null||r.script.source==null)return[];r.path=s,p.clearBreakpointsForScript(r.script);let i=[];p.collectDebugLines(i,r.script);for(let l of t){let n=i.find(c=>c.lineNumber+1==l);if(e[l]=n!=null,n!=null){let c=n.debugPoints[0];n.script.setBreakpoint(c.offset,new S(u.kBreakpoint))}}return e},V=s=>{sendDebugMessage(JSON.stringify(s))},g=(s,t,e={})=>{V({type:u.kResponse,command:s.command,success:t,request_seq:s.seq,body:e,seq:-1})},D=s=>{o&&(o.onStep=void 0);let t=o==null;if(o){let e=p.getFrameMetadata(s);e==null?t=!0:t=e.line!=x}t?new S(u.kStep).hit(s):s.onStep=function(){return D(this)}};globalThis.onDebugMessage=(s,t)=>{B=t;let e=JSON.parse(s);if(e.type==u.kRequest){if(e.command==u.kSetBreakpoints){let r=e.arguments;if(r.source.path==null||r.lines==null)return;let i=R(r.source.path,r.lines),l=[];for(let n in i)l.push({line:+n,verified:i[n],reason:i[n]?void 0:u.kFailed});g(e,!0,{breakpoints:l});return}else if(e.command==u.kStackTrace){if(o!=null){let r=e.arguments,i=[],l=o;for(;l!=null;){let n=p.getFrameMetadata(l);if(n!=null&&i.push({id:L++,line:n.line+1,column:n.col,name:n.name,source:n.source}),r.levels!=null&&i.length>=r.levels)break;l=l.older}g(e,!0,{stackFrames:i,totalFrames:i.length})}else g(e,!1);return}else if(e.command==u.kSource){let r=e.arguments,i=p.getScriptAt(r.sourceReference),l=!1,n="";i!=null&&i.source!=null&&(n=i.source.text,l=!0),g(e,l,{content:n,mimeType:"text/javascript"});return}else if(e.command==u.kScopes){g(e,!0,{scopes:[{expensive:!1,name:"Locals",presentationHint:"locals",variablesReference:y}]});return}else if(e.command==u.kVariables){let r=[],i=null,l=e.arguments;if(l.variablesReference>0&&l.variablesReference!=y?i=N[l.variablesReference]:o!=null&&(i=p.getDebuggerFrameValues(o)),i!=null)for(let n in i){if(i[n]===void 0)continue;let c=m.isPrimitive(i[n]),f={name:n,value:c?i[n]+"":typeof i[n],type:typeof i[n],variablesReference:c?0:h};r.push(f),c||(N[h]=i[n],h++)}g(e,i!=null,{variables:r});return}else if(e.command==u.kContinue){d&&(o=null,x=-1,d=!1,pause(!1)),g(e,!0);return}else if(e.command==u.kNext){o!=null&&(o.onStep=function(){return D(this)},o.onPop=function(r){this.older&&(this.older.onStep=function(){return D(this)}),this.onStep=void 0,this.onPop=void 0}),g(e,!0),d&&(d=!1,pause(!1));return}else if(e.command==u.kDisconnect){p.clearAllBreakpoints(),g(e,!0);return}}P&&println(JSON.stringify(e,null,"	"))};var F=new Debugger;F.onNewGlobalObject=s=>{F.addDebuggee(s)};F.onNewScript=s=>{let t=p.addScript(s);if(t==null)return;let e=v[t];e!=null&&R(e.path,e.lineNumbers)};})();
